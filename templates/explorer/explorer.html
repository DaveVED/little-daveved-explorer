{% extends "base.html" %}

{% block styles %}
<style>
    #map-container {
        height: 400px; /* Adjust the height as needed */
        width: 100%;
    }
</style>
{% endblock %}


{% block content %}
<!-- /explorer content -->
<div class="container mt-5">
    <!-- Intro -->
    {% include 'explorer/intro.html' %}

    <!-- Getting Started -->
    <div class="getting-started-container">
        {% include 'explorer/getting_started.html' %}
    </div>
    
    <!-- Map Container -->
    <div class="map-container">
        {% include 'fragments/map.html' with context %}
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    // Parse the coordinates JSON passed from the server
    var coordinates = JSON.parse('{{ coordinates | tojson | safe }}');

    // Initialize the Leaflet map centered over the United States
    var map = L.map('map').setView([37.0902, -95.7129], 3);

    // Add an OpenStreetMap tile layer to the map
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Iterate over the coordinates to add markers to the map
    function addMarkersToMap() {
        coordinates.forEach(function(coordinate) {
            var popupContent = `
                <b>Type:</b> ${coordinate.type}<br>
                <b>Latitude:</b> ${coordinate.latitude}<br>
                <b>Longitude:</b> ${coordinate.longitude}<br>
                <b>Created By:</b> ${coordinate.created_by}<br>
                <b>Created On:</b> ${coordinate.created_on}<br>
            `;
            
            L.marker([coordinate.latitude, coordinate.longitude])
                .bindPopup(popupContent)
                .addTo(map);
        });
    };
    addMarkersToMap();

    async function updateSelection(latitude, longitude, name) {
        try {
            const response = await fetch('/explorer/update-selection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    latitude: parseFloat(latitude),
                    longitude: parseFloat(longitude), 
                    name: name, 
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Error response:', errorData);
                alert(`Error: ${errorData.detail}`);
                return;
            }

            const data = await response.json();
            console.log(data.message);

            // Add the newly added marker to the map
            var popupContent = `
                <b>Type:</b> Hardcoded type<br>
                <b>Latitude:</b> ${latitude}<br>
                <b>Longitude:</b> ${longitude}<br>
                <b>Created By:</b> ${name}<br>
                <b>Created On:</b> ${new Date().toLocaleString()}<br>
            `;
            
            L.marker([latitude, longitude])
                .bindPopup(popupContent)
                .addTo(map);

            // Close the popup after successful update
            map.closePopup();
        } catch (error) {
            console.error('Fetch error:', error);
            alert('An error occurred while updating the selection.');
        }
    }

    var popup = L.popup();

    function onMapClick(e) {
        var latlng = e.latlng;
        var content = `
            <div>You clicked the map at ${latlng.toString()}</div>
            <button onclick='confirmLocation(${JSON.stringify(latlng)})'>Confirm</button>
        `;
        popup.setLatLng(latlng).setContent(content).openOn(map);
    }

    function confirmLocation(latlng) {
        updateSelection(latlng.lat, latlng.lng, "User Name");
    }

    map.on('click', onMapClick);
</script>
{% endblock %}
